<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0,  minimum-scale=1.0, user-scalable=0" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <title></title>
    <style type="text/css">
        html,
        body,
        #map {
            margin: 0;
            width: 100%;
            height: 100%;
            background: white;
        }
        
        #viewEntire {
            background-image: url(http://localhost:8090/iserver/services/map-sxx/rest/static/javascriptForMaps/img/viewEntire.png);
            position: absolute;
            top: 14px;
            left: 20px;
            z-index: 2000;
            width: 32px;
            height: 32px;
        }
        
        #zoomIn {
            background-image: url(http://localhost:8090/iserver/services/map-sxx/rest/static/javascriptForMaps/img/zoomIn.png);
            position: absolute;
            top: 50px;
            left: 20px;
            z-index: 2000;
            width: 32px;
            height: 32px;
        }
        
        #zoomOut {
            background-image: url(http://localhost:8090/iserver/services/map-sxx/rest/static/javascriptForMaps/img/zoomOut.png);
            position: absolute;
            top: 86px;
            left: 20px;
            z-index: 2000;
            width: 32px;
            height: 32px;
        }
    </style>

    <script src="dist/leaflet/include-leaflet.js"></script>
    <script type="text/javascript">
        var map, layer, options, prjCoordSys, epsgcode, url = "http://localhost:8090/iserver/services/map-sxx/rest/maps/City@EmergDS";
        var lon = 0,
            lat = 0,
            zoomlevel = 2,
            initZoomToScale;

        function init() {
            // 修改页面标题
            var mapName = url;
            setPrjCoordSys(); // 初始化动态投影参数
            mapName = mapName.substring(mapName.lastIndexOf('/') + 1); // 从最后一个‘/’之后开始查找
            mapName = decodeURI(mapName); // 对url进行解码
            document.title = mapName + "资源leaflet表述";

            loadMap();
        }

        function initedLayer() {
            map.addLayer(layer);
            map.setView(L.latLng(lat, lon), zoomlevel);
            map.on('move', showScale);
            showScale();
            showCoords();
        }

        function loadMap(getMapStatusEventArgs) {
            var originResult = {
                "viewBounds": {
                    "top": 3583094.2838293947,
                    "left": 1.154355096872256E7,
                    "bottom": 3581645.649992062,
                    "leftBottom": {
                        "x": 1.154355096872256E7,
                        "y": 3581645.649992062
                    },
                    "right": 1.1544999602559894E7,
                    "rightTop": {
                        "x": 1.1544999602559894E7,
                        "y": 3583094.2838293947
                    }
                },
                "viewer": {
                    "leftTop": {
                        "x": 0,
                        "y": 0
                    },
                    "top": 0,
                    "left": 0,
                    "bottom": 256,
                    "rightBottom": {
                        "x": 256,
                        "y": 256
                    },
                    "width": 256,
                    "right": 256,
                    "height": 256
                },
                "distanceUnit": "METER",
                "minVisibleTextSize": 0.1,
                "coordUnit": "METER",
                "scale": 4.675669695665377E-5,
                "description": "",
                "paintBackground": true,
                "maxVisibleTextSize": 1000,
                "maxVisibleVertex": 3600000,
                "clipRegionEnabled": false,
                "antialias": false,
                "textOrientationFixed": false,
                "angle": 0,
                "prjCoordSys": {
                    "distanceUnit": "METER",
                    "projectionParam": {
                        "centralParallel": 0,
                        "firstPointLongitude": 0,
                        "rectifiedAngle": 0,
                        "scaleFactor": 1,
                        "falseNorthing": 0,
                        "centralMeridian": 0,
                        "secondStandardParallel": 0,
                        "secondPointLongitude": 0,
                        "azimuth": 0,
                        "falseEasting": 0,
                        "firstStandardParallel": 0
                    },
                    "epsgCode": 3857,
                    "coordUnit": "METER",
                    "name": "WGS 84 /Pseudo-Mercator",
                    "projection": {
                        "name": "SPHERE_MERCATOR",
                        "type": "PRJ_SPHERE_MERCATOR"
                    },
                    "type": "PCS_WGS_1984_WEB_MERCATOR",
                    "coordSystem": {
                        "datum": {
                            "name": "D_WGS_1984",
                            "type": "DATUM_WGS_1984",
                            "spheroid": {
                                "flatten": 0.00335281066474748,
                                "name": "WGS_1984",
                                "axis": 6378137,
                                "type": "SPHEROID_WGS_1984"
                            }
                        },
                        "unit": "DEGREE",
                        "spatialRefType": "SPATIALREF_EARTH_LONGITUDE_LATITUDE",
                        "name": "GCS_WGS_1984",
                        "type": "GCS_WGS_1984",
                        "primeMeridian": {
                            "longitudeValue": 0,
                            "name": "Greenwich",
                            "type": "PRIMEMERIDIAN_GREENWICH"
                        }
                    }
                },
                "minScale": 0,
                "markerAngleFixed": false,
                "overlapDisplayedOptions": {
                    "allowPointWithTextDisplay": true,
                    "horizontalOverlappedSpaceSize": 0,
                    "allowPointOverlap": true,
                    "allowThemeGraduatedSymbolOverlap": false,
                    "verticalOverlappedSpaceSize": 0,
                    "allowTextOverlap": false,
                    "allowThemeGraphOverlap": false,
                    "allowTextAndPointOverlap": true
                },
                "visibleScales": [],
                "dpi": 96,
                "visibleScalesEnabled": false,
                "customEntireBoundsEnabled": false,
                "clipRegion": {
                    "center": null,
                    "parts": null,
                    "style": null,
                    "prjCoordSys": null,
                    "id": 0,
                    "type": "REGION",
                    "partTopo": null,
                    "points": null
                },
                "maxScale": 1.0E12,
                "customParams": "",
                "center": {
                    "x": 1.1544275285641227E7,
                    "y": 3582369.9669107283
                },
                "dynamicPrjCoordSyses": [{
                    "distanceUnit": null,
                    "projectionParam": null,
                    "epsgCode": 0,
                    "coordUnit": null,
                    "name": null,
                    "projection": null,
                    "type": "PCS_ALL",
                    "coordSystem": null
                }],
                "colorMode": "DEFAULT",
                "textAngleFixed": false,
                "overlapDisplayed": false,
                "userToken": {
                    "userID": ""
                },
                "cacheEnabled": true,
                "dynamicProjection": false,
                "autoAvoidEffectEnabled": true,
                "customEntireBounds": null,
                "name": "City@EmergDS",
                "bounds": {
                    "top": 3585516.41339198,
                    "left": 1.1541226602196597E7,
                    "bottom": 3579087.711007227,
                    "leftBottom": {
                        "x": 1.1541226602196597E7,
                        "y": 3579087.711007227
                    },
                    "right": 1.1546271446063416E7,
                    "rightTop": {
                        "x": 1.1546271446063416E7,
                        "y": 3585516.41339198
                    }
                },
                "backgroundStyle": {
                    "fillGradientOffsetRatioX": 0,
                    "markerSize": 2.4,
                    "fillForeColor": {
                        "red": 255,
                        "green": 255,
                        "blue": 255,
                        "alpha": 255
                    },
                    "fillGradientOffsetRatioY": 0,
                    "markerWidth": 0,
                    "markerAngle": 0,
                    "fillSymbolID": 0,
                    "lineColor": {
                        "red": 0,
                        "green": 0,
                        "blue": 0,
                        "alpha": 255
                    },
                    "markerSymbolID": 0,
                    "lineWidth": 0.1,
                    "markerHeight": 0,
                    "fillOpaqueRate": 100,
                    "fillBackOpaque": true,
                    "fillBackColor": {
                        "red": 255,
                        "green": 255,
                        "blue": 255,
                        "alpha": 255
                    },
                    "fillGradientMode": "NONE",
                    "lineSymbolID": 0,
                    "fillGradientAngle": 0
                }
            };
            var visableResolution = [];
            var mapcrs = L.CRS.EPSG3857;
            options = {};
            // 初始化时修改成22级，和计算scales数组时保持一致
            options.maxZoom = 22;
            options.minZoom = 0;
            var maxZoom = 22;
            var zoom = 0;
            if (originResult.overlapDisplayed) {
                options.overlapDisplayed = originResult.overlapDisplayed;
            }
            var envelope;

            if (originResult.prjCoordSys) {
                var resolution;
                if (originResult.prjCoordSys.coordUnit) {
                    //如果单位为米
                    //获取分辨率
                    resolution = scaleToResolution(originResult.scale, 96, originResult.prjCoordSys.coordUnit);
                }
                if (visableResolution.length == 0) {
                    envelope = getProjectionExtent();
                    if (!envelope) {
                        //设置地图显示范围
                        envelope = originResult.bounds;
                    }
                    //获取分辨率数组
                    visableResolution = getStyleResolutions(envelope);

                    var scales = getScales(envelope, originResult.prjCoordSys.coordUnit);
                    if (originResult.scale) {
                        var temp;
                        for (var j = 0; j < scales.length; j++) {
                            if (j == 0) {
                                temp = Math.abs(originResult.scale - scales[j]);
                            }
                            if (temp > Math.abs(originResult.scale - scales[j])) {
                                temp = Math.abs(originResult.scale - scales[j]);
                                zoom = j;
                            }
                        }
                    }
                } else {
                    if (resolution) {
                        var temp;
                        for (var j = 0; j < visableResolution.length; j++) {
                            if (j == 0) {
                                temp = Math.abs(resolution - visableResolution[j]);
                            }
                            if (temp > Math.abs(resolution - visableResolution[j])) {
                                temp = Math.abs(resolution - visableResolution[j]);
                                zoom = j;
                            }
                        }
                    }
                }
                if (epsgcode && originResult.prjCoordSys.type != "PCS_NON_EARTH") { //有设置动态投影而且不是平面坐标的地图
                    if (epsgcode == "4326") {
                        console.log("我是动态投影4326")
                        options.projection = 4326;
                        if (visableResolution.length > 0) {
                            mapcrs = getCRS("EPSG:4326", originResult.bounds, visableResolution);
                        } else {
                            mapcrs = getCRS("EPSG:4326", originResult.bounds);
                        }
                    } else if (epsgcode == "3857") {
                        console.log("我是动态投影3857")
                        options.projection = 3857;
                        if (visableResolution.length > 0) {
                            mapcrs = getCRS("EPSG:3857", originResult.bounds, visableResolution);
                        } else {
                            mapcrs = getCRS("EPSG:3857", originResult.bounds);
                        }
                    }
                } else { //没有设置动态投影
                    if (originResult.prjCoordSys.epsgCode == "4326" || originResult.prjCoordSys.type == "PCS_EARTH_LONGITUDE_LATITUDE") {
                        console.log("我是非动态投影4326")
                        lon = (originResult.bounds.left + originResult.bounds.right) / 2;
                        lat = (originResult.bounds.bottom + originResult.bounds.top) / 2;
                        if (visableResolution.length > 0) {
                            mapcrs = getCRS("EPSG:4326", originResult.bounds, visableResolution);
                        } else {
                            mapcrs = getCRS("EPSG:4326", originResult.bounds);
                        }
                    } else if (originResult.prjCoordSys.type == "PCS_NON_EARTH") {
                        console.log("我是非动态投影平面")
                        mapcrs = L.CRS.NonEarthCRS({

                            bounds: L.bounds([originResult.bounds.left, originResult.bounds.bottom], [originResult.bounds.right, originResult.bounds.top]),
                            origin: L.point(originResult.bounds.left, originResult.bounds.top)
                        });
                    } else {
                        console.log("我是非动态投影3857")
                        if (visableResolution.length > 0) {
                            console.log("哈哈")
                            console.log(visableResolution)
                            console.log(originResult.bounds)
                            mapcrs = getCRS("EPSG:3857", originResult.bounds, visableResolution);
                        } else {
                            mapcrs = getCRS("EPSG:3857", originResult.bounds);
                            console.log("嘿嘿")
                        }
                    }
                }
            }

            if (visableResolution.length > 0) {
                maxZoom = visableResolution.length - 1;
                options.maxZoom = visableResolution.length - 1;
            }


            map = L.map('map', {
                //crs: L.CRS.EPSG3857
                center: mapcrs.unproject(L.point((originResult.bounds.left + originResult.bounds.right) / 2, (originResult.bounds.bottom + originResult.bounds.top) / 2)),
                maxZoom: maxZoom,
                zoom: zoom,
                crs: mapcrs,
            });
            console.log(mapcrs.unproject(L.point((originResult.bounds.left + originResult.bounds.right) / 2, (originResult.bounds.bottom + originResult.bounds.top) / 2)))
            var layerUrl = "http://localhost:8090/iserver/services/map-sxx/rest/maps/City@EmergDS";
            console.log(options)
            layer = L.supermap.tiledMapLayer(layerUrl, options);
            layer.addTo(map);

        }

        function getCRS(epsgCodeStr, bounds, resolutions) {
            return L.Proj.CRS(epsgCodeStr, {
                bounds: L.bounds([bounds.left, bounds.bottom], [bounds.right, bounds.top]),
                resolutions: resolutions,
                origin: [bounds.left, bounds.top]
            });
        }

        function zoomIn() {
            map.zoomIn();
        }

        function zoomOut() {
            map.zoomOut();
        }

        function viewEntire() {
            var mapDiv = document.getElementById("map");
            var minSize = Math.min(parseInt(mapDiv.clientWidth), parseInt(mapDiv.clientHeight));

            var zoomLevel = Math.floor(Math.log(minSize / 256) / Math.LN2);
            map.setView(L.latLng(lat, lon), zoomLevel);
        }

        function showScale() {
            var scale = layer.getScale();
            scale = parseInt(1 / scale * 10) / 10;
            var scaleText = document.getElementById("scaleText");
            scaleText.value = "比例尺： 1/" + scale;
        }

        function showCoords() {
            var mapdiv = document.getElementById("map");
            var coordsText = document.getElementById("coordsText");
            mapdiv.onmousemove = function(e) {
                e = e || window.event;
                var point = map.mouseEventToLatLng(e);
                coordsText.value = parseFloat(point.lat).toFixed(4) + "," + parseFloat(point.lng).toFixed(4);
            }
        }

        function getProjectionExtent() {
            var requestUrl = "http://localhost:8090/iserver/services/map-sxx/rest/maps/City@EmergDS";
            requestUrl = requestUrl + "/" + "prjCoordSys/projection/extent.json";
            var commit = new Requester();
            extent = commit.sendRequestWithResponse(requestUrl, "GET", null);
            if (extent) {
                var result = eval('(' + extent + ')');
                if (result && result.left && result.right && result.top && result.bottom) {
                    console.log(result)
                    return result;
                }
            }
            return null;
        }

        function setPrjCoordSys() { // 支持动态投影，解析url相应参数
        }

        function scaleToResolution(scale, dpi, mapUnit) {
            var inchPerMeter = 1 / 0.0254;
            var meterPerMapUnitValue = getMeterPerMapUnit(mapUnit); //地图上每一米对应多少值
            //比例尺*dpi*英寸/米*地图实际对应米数
            var resolution = scale * dpi * inchPerMeter * meterPerMapUnitValue;
            //取倒数
            resolution = 1 / resolution;
            return resolution;
        }

        function resolutionToScale(resolution, dpi, mapUnit) {
            var inchPerMeter = 1 / 0.0254;
            // 地球半径。
            var meterPerMapUnit = getMeterPerMapUnit(mapUnit);
            var scale = resolution * dpi * inchPerMeter * meterPerMapUnit;
            scale = 1 / scale;
            return scale;
        }

        function getMeterPerMapUnit(mapUnit) {
            var earchRadiusInMeters = 6378137; // 6371000;
            var meterPerMapUnit;
            if (mapUnit == "METER") {
                meterPerMapUnit = 1;
            } else if (mapUnit == "DEGREE") {
                // 每度表示多少米。
                meterPerMapUnit = Math.PI * 2 * earchRadiusInMeters / 360;
            } else if (mapUnit == "KILOMETER") {
                meterPerMapUnit = 1.0E-3;
            } else if (mapUnit == "INCH") {
                meterPerMapUnit = 1 / 2.5399999918E-2;
            } else if (mapUnit == "FOOT") {
                meterPerMapUnit = 0.3048;
            }
            return meterPerMapUnit;
        }

        //由于mvt的style渲染必须要传一个完整的分辨率数组，这里计算出一个从0开始的分辨率数组
        function getStyleResolutions(bounds) {
            var styleResolutions = [];
            var temp = Math.abs(bounds.left - bounds.right) / 256;
            for (var i = 0; i < 22; i++) {
                if (i == 0) {
                    styleResolutions[i] = temp;
                    continue;
                }
                temp = temp / 2;
                styleResolutions[i] = temp;
            }
            return styleResolutions;
        }

        function getScales(bounds, coordUnit) {
            var resolution0 = Math.abs(bounds.left - bounds.right) / 256;
            var temp = resolutionToScale(resolution0, 96, coordUnit);
            var scales = [];
            for (var i = 0; i < 22; i++) {
                if (i == 0) {
                    scales[i] = temp;
                    continue;
                }
                temp = temp * 2;
                scales[i] = temp;
            }
            return scales;
        }

        Requester = function() {
            this.commit = null;
            try {
                this.commit = new ActiveXObject("Msxml2.XMLHTTP");
            } catch (ex) {
                try {
                    this.commit = new ActiveXObject("Microsoft.XMLHTTP");
                } catch (ex) {
                    this.commit = null;
                }
            }
            if (!this.commit && typeof XMLHttpRequest != "undefined") {
                this.commit = new XMLHttpRequest();
            }
            /**
             * 发送异步请求。
             */
            this.sendRequest = function(url, method, entry, onComplete) {
                    var xhr = this.commit;
                    xhr.open(method, url, true);
                    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded; charset=UTF-8");
                    xhr.onreadystatechange = function() {
                        var readyState = xhr.readyState;
                        if (readyState == 4) {
                            var status = xhr.status;
                            var responseText = xhr.responseText;
                            onComplete(responseText);

                            xhr.onreadystatechange = function() {};
                            xhr = null;
                        }
                    };
                    xhr.send(entry);
                }
                /**
                 * 发送一个同步请求。
                 */
            this.sendRequestWithResponse = function(url, method, entry) {
                var xhr = this.commit;
                xhr.open(method, encodeURI(url), false);
                xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded; charset=UTF-8");
                xhr.send(entry);
                return xhr.responseText;
            }
        }
    </script>
</head>

<body onload="init()">
    <div id="map"></div>
    <!--
    <div id="measureResult" style="position:absolute;bottom:23px;right:10px;z-index:2000; text-align: right;">
        <p><input id="result" type="text" value="" style="background:none;border:none" readonly="true" /></p>
	</div>
	-->
    <div id="coordsResult" style="position:absolute;bottom:5px;right:10px;z-index:2000; text-align: right;">
        <p><input id="coordsText" type="text" value="" style="background:none;border:none" readonly="true" /></p>
    </div>
    <div id="scaleResult" style="position:absolute;bottom:23px;right:10px;z-index:2000; text-align: right;">
        <p><input id="scaleText" type="text" value="" style="background:none;border:none" readonly="true" /></p>
    </div>

</body>

</html>